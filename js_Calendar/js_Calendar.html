<!doctype html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- font awesome -->
  <script src="https://kit.fontawesome.com/05704b3d70.js" crossorigin="anonymous"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@100;300;400;500;700;900&family=Noto+Serif+TC:wght@300;400;500;600;700;900&display=swap"
    rel="stylesheet">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  <title>行事曆</title>
</head>
<style>
  body {
    background: rgb(240, 240, 240);
  }

  .wrapper {
    max-width: 960px;
    padding: 10px;
    font-family: 'Noto Sans TC', sans-serif;
    font-family: 'Noto Serif TC', serif;
  }

  .container {
    justify-content: space-between;
  }

  li {
    font-size: 12px;
  }

  .fa-solid {
    color: lightgray;
    transition: all .5s;
  }

  th {
    font-size: 16px;
  }

  .side-task {
    font-size: 12px;
  }

  .show-date {
    margin-top: 24px;
  }

  .task-item {
    font-size: 12px;
  }

  .y-txt {
    font-weight: 900;
    color: rgb(160, 160, 160);

  }

  .month {
    font-weight: 800;
    color: rgb(120, 120, 110);
  }

  .month-ctrl>span {
    color: rgb(120, 120, 110);
    font-weight: 900;
  }

  button {
    background-color: transparent;
    border: 0px transparent;
  }

  button:hover .fa-solid {
    color: black;
  }



  td {
    height: 80px;
    font-size: 12px;
    border: 1px solid rgb(210, 210, 210);
  }

  th {
    list-style: none;
    font-size: 12px;
    width: 100px;
    border: 1px solid rgb(210, 210, 210);
  }


  ::-webkit-scrollbar {
    display: none;
  }

  ul {
    padding: 5px;
    list-style-type: none;
  }

  .task-item {
    height: 40px;
    padding-inline-start: 0px;
    overflow: auto;
  }

  td:hover {
    background-color: rgb(230, 230, 230);
  }

  li {
    background-color: rgb(190, 190, 180);
    border-radius: 5px;
    text-align: center;
    margin-bottom: 2px;
    color: rgba(0, 0, 0, 70%);
    font-size: 11px;
    padding: 2px;
    font-weight: light;
    letter-spacing: 1px;
  }

  .mur {
    /* writing-mode: vertical-lr; */
    background-color: transparent;
    overflow: auto;
    height: 200px;
    border-left: 1px solid rgb(180, 180, 180);
    ;
  }

  .mur ul li {
    background-color: transparent;
    border-top: none;
    border-left: none;
    border-right: none;
    border-bottom-color: lightgray;
    font-size: 12px;
  }

  .mur ul li:hover {
    background-color: rgba(190, 190, 180, 30%);
    border-radius: none;
  }

  .fa-house-user {
    font-size: 14px;
  }

  .today:hover .fa-house-user {
    color: rgb(160, 160, 160);
    cursor: pointer;
    font-size: 17px;
  }
</style>

<body>
  <div class="wrapper m-auto w-100">
    <div class="container d-flex w-100">
      <div class="show-date col-2 align-items-center">
        <div class="year-txt d-flex flex-column">
          <div class="y-txt year-4 text-center fs-4">2</div>
          <div class="y-txt year-3 text-center fs-4">0</div>
          <div class="y-txt year-2 text-center fs-4">2</div>
          <div class="y-txt year-1 text-center fs-4">2</div>
          <div class="today text-center mt-4 mb-4"><i class="fa-solid fa-house-user"></i></div>
        </div>
        <div class="month-ctrl d-flex flex-column align-items-center mt-2 ">
          <div class="month-group d-flex align-items-center">
            <button class="button last-month"><i class="fa-solid fa-angle-left"></i></button>
            <span class="month text-center m-3 fs-3">{{7}}</span>
            <button class="button next-month"><i class="fa-solid fa-angle-right"></i></button>
          </div>
          <span class="fs-4 mb-5">月</span>
          <div class="mur text-center mt-4">
            <!-- <ul class="list-group list-group-flushs">
              <li class="list-group-item list-group-item-action task"></li>
            </ul> -->
          </div>
        </div>
      </div>
      <div class="cal col-10 p-3">
        <div class="title mb-4 fs-1 p-1">行事曆</div>
        <table class="table">
          <thead>
            <tr>
              <th class="text-center">日</th>
              <th class="text-center">一</th>
              <th class="text-center">二</th>
              <th class="text-center">三</th>
              <th class="text-center">四</th>
              <th class="text-center">五</th>
              <th class="text-center">六</th>
            </tr>
          </thead>
          <tbody>
            <!-- {{日期在這邊動態生}} -->
          </tbody>
        </table>
      </div>
    </div>
  </div>


  <!-- 新增行程Modal -->
  <div id="add-event-modal" class="modal fade" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">增加行程</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input id="add-date" type="text">
          <input id="add-value" type="text" placeholder="新增行程...">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" onclick="addTodoItem()">新增</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 編輯行程Modal -->
  <div id="edit-event-modal" class="modal fade" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">編輯</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input id="edit-date" type="text">
          <input id="edit-value" type="text" placeholder="新增行程...">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-danger" onclick="deleteTodoItem()">刪除</button>
          <button type="button" class="btn btn-primary" onclick="editTodoItem()">修改</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
    crossorigin="anonymous"></script>


  <script>

    // 宣告
    const today = new Date() // 今天
    let year = today.getFullYear()  //年
    let month = today.getMonth()//月
    let date = today.getDate() //日
    let currentIndex

    //此月曆一萬年以後不適用
    let y4 = parseInt(year / 1000)
    let y3 = parseInt(year % 1000 / 100)
    let y2 = parseInt(year % 1000 % 100 / 10)
    let y1 = parseInt(year % 1000 % 100 % 10 / 1)

    // DOM
    const year4 = document.querySelector('.year-4')
    const year3 = document.querySelector('.year-3')
    const year2 = document.querySelector('.year-2')
    const year1 = document.querySelector('.year-1')

    const homepage = document.querySelector('.today')

    const monthText = document.querySelector('.month')
    const lastBtn = document.querySelector('.last-month')
    const nextBtn = document.querySelector('.next-month')
    const tbodyDate = document.querySelector('tbody')
    const showDate = document.querySelector('.year-txt')

    const addModal = document.querySelector('#add-event-modal')
    const editModal = document.querySelector('#edit-event-modal')

    const addDateInput = document.querySelector('#add-date')
    const addValueInput = document.querySelector('#add-value')
    const editDateInput = document.querySelector('#edit-date')
    const editValueInput = document.querySelector('#edit-value')
    const title = document.querySelector('.modal-title')

    const task = document.querySelector('.task')


    //window.onload
    window.onload = function () {
      generateCal()
      initialYear()
      lastBtn.addEventListener('click', lastMonth)
      nextBtn.addEventListener('click', nextMonth)
      homepage.addEventListener('click', goToday)
      console.log(showDate)
      // console.dir(task)
      // task.addEventListener('click',()=>{
      //   console.dir(task)
      //   task.style="text-decoration:line-through"
      // })
    }


    //function
    function generateCal() {
      tbodyDate.innerHTML = ''
      year4.innerText = y4
      year3.innerText = y3
      year2.innerText = y2
      year1.innerText = y1
      monthText.innerText = month + 1

      //這個月的第一天是星期幾
      let firstDay = new Date(year, month, 1).getDay()

      //知道這個月有幾天
      let dayOfMonth = new Date(year, month + 1, 0).getDate()

      //產出多少行數
      let day = 1
      let rows = Math.ceil((dayOfMonth + firstDay) / 7)

      for (let row = 0; row < rows; row++) {
        let tr = document.createElement('tr')
        for (let col = 0; col < 7; col++) {
          let td = document.createElement('td')
          if (row == 0 && col < firstDay) {
            //上個月剩餘的天數
            td.innerText = ''
          }
          else {
            if (day <= dayOfMonth) {
              //這個月的
              td.innerText = day

              if (localStorage.getItem(`${year}-${month + 1}-${day}`) != null) {
                let ul = document.createElement('ul')
                ul.classList.add('task-item')
                let todoList = JSON.parse(localStorage.getItem(`${year}-${month + 1}-${day}`))

                todoList.forEach((item, index) => {
                  let li = document.createElement('li')
                  li.innerText = item.title
                  li.onclick = function (event) {
                    bootstrap.Modal.getOrCreateInstance(editModal).show()
                    currentIndex = index
                    editDateInput.value = `${year}-${month + 1}-${td.childNodes[0].data}`
                    editValueInput.value = item.title
                    event.stopPropagation()
                  }
                  ul.appendChild(li)
                })
                td.appendChild(ul)
              }

              td.onclick = function () {
                bootstrap.Modal.getOrCreateInstance(addModal).show()
                addDateInput.value = `${year}-${month + 1}-${td.childNodes[0].data}`
                title.innerText = `${year}/${month + 1}/${date}行程`
                console.dir(td)

              }
              day++
            }
            else {
              // 下個月的
              td.innerText = ''
            }
          }
          tr.appendChild(td)
        }
        tbodyDate.appendChild(tr)
      }
    }


    function goToday() {
      year = today.getFullYear()  //年
      month = today.getMonth()//月
      date = today.getDate() //日
      y4 = parseInt(year / 1000)
      y3 = parseInt(year % 1000 / 100)
      y2 = parseInt(year % 1000 % 100 / 10)
      y1 = parseInt(year % 1000 % 100 % 10 / 1)
      cleanYear()
      year4.innerText = y4
      year3.innerText = y3
      year2.innerText = y2
      year1.innerText = y1
      generateCal()
    }

    // 往上個月
    function lastMonth() {
      //month從0(一月)變成-1月，就是上一年
      month--
      if (month == -1) {
        year--
        month = 11
        y4 = parseInt(year / 1000)
        y3 = parseInt(year % 1000 / 100)
        y2 = parseInt(year % 1000 % 100 / 10)
        y1 = parseInt(year % 1000 % 100 % 10 / 1)
      }

      console.log(year)
      cleanYear()
      //換到下一個月重新整理一次行事曆的格子
      generateCal()

    }


    // 往下個月
    function nextMonth() {
      month++
      if (month == 12) {
        year++
        month = 0
        y4 = parseInt(year / 1000)
        y3 = parseInt(year % 1000 / 100)
        y2 = parseInt(year % 1000 % 100 / 10)
        y1 = parseInt(year % 1000 % 100 % 10 / 1)
      }
      console.log(year)
      cleanYear()
      console.log(y4)

      //換到下一個月重新整理一次行事曆的格子
      generateCal()
    }

    function addTodoItem() {
      let date = addDateInput.value
      let todoItem = addValueInput.value

      let todoObj = {
        title: todoItem
      }

      let todoList = []

      if (localStorage.getItem(date) == null) {
        todoList.push(todoObj)
      } else {
        todoList = JSON.parse(localStorage.getItem(date))
        todoList.push(todoObj)
      }
      localStorage.setItem(date, JSON.stringify(todoList))
      bootstrap.Modal.getOrCreateInstance(addModal).hide()
      generateCal()
    }

    function editTodoItem() {
      let date = editDateInput.value
      let todoItem = editValueInput.value
      let todoList = JSON.parse(localStorage.getItem(date))
      todoList[currentIndex] = { title: todoItem }
      localStorage.setItem(date, JSON.stringify(todoList))
      bootstrap.Modal.getOrCreateInstance(editModal).hide()
      generateCal()
    }

    function deleteTodoItem() {
      let date = editDateInput.value
      let todoList = JSON.parse(localStorage.getItem(date))
      todoList.splice(currentIndex, 1)

      localStorage.setItem(date, JSON.stringify(todoList))
      bootstrap.Modal.getOrCreateInstance(editModal).hide()
      generateCal()
    }

    function showTodo() {
      li.onclick = function (event) {
      }
    }

    function initialYear() {
      year4.innerText = y4
      year3.innerText = y3
      year2.innerText = y2
      year1.innerText = y1
    }

    function cleanYear() {
      year4.innerText = ''
      year3.innerText = ''
      year2.innerText = ''
      year1.innerText = ''
    }

    // function addLineThrough() {
    //   let task = document.querySelector('lineThrough')
    // }

  </script>
</body>

</html>